use num_traits::PrimInt;
use num_traits::Zero;
use std::collections::HashMap;
use std::hash::Hash;
use std::ops::{Div, DivAssign, Mul, MulAssign, Rem};

pub(crate) fn pgcd<N>(_a: N, _b: N) -> N
where
    N: Zero + Rem + Eq + DivAssign + Copy + From<<N as Rem>::Output>,
{
    if _a.is_zero() {
        return _b;
    }
    if _b.is_zero() {
        return _a;
    }

    let mut a = _a;
    let mut b = _b;
    loop {
        let pgcd: N = (a % b).into();
        if pgcd.is_zero() {
            return b;
        }
        a = b;
        b = pgcd;
    }
}

pub(crate) fn ppcm<N>(a: N, b: N) -> N
where
    N: Zero
        + Mul
        + Div
        + Rem
        + Eq
        + DivAssign
        + Copy
        + From<<N as Rem>::Output>
        + From<<N as Div>::Output>
        + From<<N as Mul>::Output>,
{
    let ab: N = (a * b).into();
    (ab / pgcd(a, b)).into()
}

pub(crate) fn number_of_divisors<'a, N, V>(mut _n: N, primes: V) -> u32
where
    N: PrimInt + DivAssign + Copy + 'a,
    V: IntoIterator<Item = &'a N>,
{
    let zero = N::zero();
    let mut n = _n;
    let mut d: u32 = 1;
    for &p in primes {
        if p * p > n {
            break;
        }
        if n % p == zero {
            let mut compteur: u32 = 0;
            while (n % p) == zero {
                n /= p;
                compteur += 1;
            }
            d *= compteur + 1;
        }
    }

    if n > N::one() {
        d *= 2;
    }

    d
}

pub(crate) fn factorization<'a, N, V, F>(_n: N, primes: V, mut output: F)
where
    N: PrimInt + DivAssign + Copy + 'a,
    V: IntoIterator<Item = &'a N>,
    F: FnMut(N, usize),
{
    let mut n = _n;
    for &p in primes {
        if p * p > n {
            break;
        }
        if (n % p).is_zero() {
            let mut count: usize = 0;
            while (n % p).is_zero() {
                n /= p;
                count += 1;
            }
            output(p, count);
        }
    }

    if n > N::one() {
        output(n, 1);
    }
}

pub(crate) fn divisors<'a, N, V>(_n: N, primes: V) -> Vec<N>
where
    N: PrimInt + MulAssign + DivAssign + Copy + 'a + Hash,
    V: IntoIterator<Item = &'a N>,
{
    let mut factor: HashMap<N, usize> = HashMap::new();
    factorization(_n, primes, |p, d| {
        factor.insert(p, d);
    });

    let mut result = Vec::new();
    result.push(N::one());

    for (p, exp) in factor {
        let mut r = result.clone();
        let mut f = p;
        for _ in 0..exp {
            result.iter().map(|i| i.mul(f)).for_each(|i| r.push(i));
            f *= p;
        }

        result = r;
    }

    result.sort();
    result
}

pub(crate) fn sum_of_divisors<'a, N, V>(mut _n: N, primes: V) -> N
where
    N: PrimInt + MulAssign + DivAssign + Copy + 'a,
    V: IntoIterator<Item = &'a N>,
{
    let one = N::one();
    let mut s = N::one();
    let mut n = _n;
    for &p in primes {
        if p * p > n {
            break;
        }
        if (n % p).is_zero() {
            let mut count: u32 = 0;
            while (n % p).is_zero() {
                n /= p;
                count += 1;
            }
            s *= (p.pow(count + 1) - one) / (p - one);
        }
    }

    if n > N::one() {
        s *= n + one;
    }
    s
}

pub(crate) fn phi<'a, N, V>(mut _n: N, primes: V) -> N
where
    N: PrimInt + MulAssign + DivAssign + Copy + 'a,
    V: IntoIterator<Item = &'a N>,
{
    let mut result = _n;
    let mut n = _n;
    for &p in primes {
        if p * p > n {
            break;
        }
        if (n % p).is_zero() {
            result = result - result / p;
            while (n % p).is_zero() {
                n /= p;
            }
        }
    }

    let one = N::one();
    if n > one {
        result = result - result / n;
    }
    result
}

#[cfg(test)]
mod tests {
    use super::*;
    use std::collections::HashMap;

    #[test]
    fn test_pgcd() {
        assert_eq!(pgcd(456753, 97643), 1);
        assert_eq!(pgcd(456755, 158665), 65);
    }

    #[test]
    fn test_ppcm() {
        assert_eq!(ppcm(456753u64, 97643u64), 44598733179u64);
        assert_eq!(ppcm(456755u64, 158665u64), 1114938955u64);
    }

    #[test]
    fn test_number_of_divisors() {
        let primes: Vec<u64> = vec![
            2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37, 41, 43, 47, 53, 59, 61, 67, 71, 73, 79, 83,
            89, 97,
        ];
        assert_eq!(number_of_divisors(456753, &primes), 8);
        assert_eq!(number_of_divisors(3246999210, &primes), 640);
    }
    #[test]
    fn test_sum_of_divisors() {
        let primes: Vec<u64> = vec![
            2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37, 41, 43, 47, 53, 59, 61, 67, 71, 73, 79, 83,
            89, 97,
        ];
        assert_eq!(sum_of_divisors(456753, &primes), 664416);
        assert_eq!(sum_of_divisors(496, &primes), 992);
        assert_eq!(sum_of_divisors(3246999210u64, &primes), 11708928000);
    }
    #[test]
    fn test_phi() {
        let primes: Vec<u64> = vec![
            2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37, 41, 43, 47, 53, 59, 61, 67, 71, 73, 79, 83,
            89, 97,
        ];
        assert_eq!(phi(3246999210, &primes), 640120320);
        assert_eq!(phi(496, &primes), 240);
    }
    #[test]
    fn test_factorization() {
        let primes: Vec<u64> = vec![
            2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37, 41, 43, 47, 53, 59, 61, 67, 71, 73, 79, 83,
            89, 97,
        ];
        let mut d: HashMap<u64, usize> = HashMap::new();
        factorization(3246999210u64, &primes, |p, c| {
            d.insert(p, c);
        });
        println!("{:?}", d);
        let expected = HashMap::from([(29, 1), (7, 3), (13, 1), (3, 4), (5, 1), (31, 1), (2, 1)]);
        assert_eq!(d, expected);
    }
    #[test]
    fn test_divisors() {
        let primes: Vec<u64> = vec![
            2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37, 41, 43, 47, 53, 59, 61, 67, 71, 73, 79, 83,
            89, 97,
        ];
        let d = divisors(3246999210u64, &primes);
        println!("{:?}", d);
        let expected:Vec<u64> = vec![
            1, 2, 3, 5, 6, 7, 9, 10, 13, 14, 15, 18, 21, 26, 27, 29, 30, 31, 35, 39, 42, 45, 49,
            54, 58, 62, 63, 65, 70, 78, 81, 87, 90, 91, 93, 98, 105, 117, 126, 130, 135, 145, 147,
            155, 162, 174, 182, 186, 189, 195, 203, 210, 217, 234, 245, 261, 270, 273, 279, 290,
            294, 310, 315, 343, 351, 377, 378, 390, 403, 405, 406, 434, 435, 441, 455, 465, 490,
            522, 546, 558, 567, 585, 609, 630, 637, 651, 686, 702, 735, 754, 783, 806, 810, 819,
            837, 870, 882, 899, 910, 930, 945, 1015, 1029, 1053, 1085, 1131, 1134, 1170, 1209,
            1218, 1274, 1302, 1305, 1323, 1365, 1395, 1421, 1470, 1519, 1566, 1638, 1674, 1715,
            1755, 1798, 1827, 1885, 1890, 1911, 1953, 2015, 2030, 2058, 2106, 2170, 2205, 2262,
            2349, 2418, 2457, 2511, 2610, 2639, 2646, 2697, 2730, 2790, 2821, 2835, 2842, 3038,
            3045, 3087, 3185, 3255, 3393, 3430, 3510, 3627, 3654, 3770, 3822, 3906, 3915, 3969,
            4030, 4095, 4185, 4263, 4410, 4459, 4495, 4557, 4698, 4914, 5022, 5145, 5265, 5278,
            5394, 5481, 5642, 5655, 5670, 5733, 5859, 6045, 6090, 6174, 6293, 6370, 6510, 6615,
            6786, 7105, 7254, 7371, 7595, 7830, 7917, 7938, 8091, 8190, 8370, 8463, 8526, 8918,
            8990, 9114, 9135, 9261, 9555, 9765, 9947, 10179, 10290, 10530, 10633, 10881, 10962,
            11310, 11466, 11687, 11718, 11745, 12090, 12285, 12555, 12586, 12789, 13195, 13230,
            13377, 13485, 13671, 14105, 14210, 14742, 15190, 15435, 15834, 16182, 16443, 16926,
            16965, 17199, 17577, 18135, 18270, 18473, 18522, 18879, 19110, 19530, 19747, 19845,
            19894, 20358, 21266, 21315, 21762, 22295, 22785, 23374, 23490, 23751, 24273, 24570,
            25110, 25389, 25578, 26390, 26754, 26970, 27342, 27405, 27783, 28210, 28665, 29295,
            29841, 30537, 30870, 31465, 31899, 32643, 32886, 33930, 34398, 35061, 35154, 36270,
            36855, 36946, 37758, 38367, 39494, 39585, 39690, 40131, 40455, 41013, 42315, 42630,
            44051, 44590, 45570, 46305, 47502, 48546, 49735, 50778, 50895, 51597, 53165, 54405,
            54810, 55419, 55566, 56637, 57330, 58435, 58590, 59241, 59682, 61074, 62930, 63798,
            63945, 65286, 66885, 68355, 70122, 71253, 72819, 73710, 76167, 76734, 79170, 80262,
            80910, 81809, 82026, 82215, 84630, 85995, 87885, 88102, 89523, 92365, 92610, 94395,
            95697, 98735, 99470, 101790, 103194, 105183, 106330, 108810, 110838, 113274, 115101,
            116870, 118482, 118755, 120393, 121365, 123039, 126945, 127890, 129311, 132153, 133770,
            136710, 138229, 138915, 142506, 145638, 149205, 152334, 152685, 159495, 163215, 163618,
            164430, 166257, 169911, 171990, 175305, 175770, 177723, 179046, 184730, 188790, 191394,
            191835, 197470, 200655, 205065, 210366, 213759, 220255, 228501, 230202, 237510, 240786,
            242730, 245427, 246078, 253890, 257985, 258622, 264306, 268569, 276458, 277095, 277830,
            283185, 287091, 296205, 298410, 305370, 308357, 315549, 318990, 326430, 332514, 339822,
            350610, 355446, 356265, 361179, 364095, 380835, 383670, 387933, 396459, 401310, 409045,
            410130, 414687, 427518, 440510, 447615, 457002, 478485, 490854, 498771, 509733, 515970,
            525915, 533169, 537138, 554190, 566370, 572663, 574182, 575505, 592410, 601965, 615195,
            616714, 631098, 646555, 660765, 691145, 712530, 722358, 728190, 736281, 761670, 775866,
            792918, 805707, 818090, 829374, 831285, 849555, 861273, 888615, 895230, 925071, 946647,
            956970, 997542, 1019466, 1051830, 1066338, 1068795, 1142505, 1145326, 1151010, 1163799,
            1189377, 1203930, 1227135, 1230390, 1244061, 1293110, 1321530, 1342845, 1382290,
            1435455, 1472562, 1496313, 1541785, 1577745, 1599507, 1611414, 1662570, 1699110,
            1717989, 1722546, 1777230, 1805895, 1850142, 1893294, 1939665, 1982295, 2073435,
            2137590, 2208843, 2285010, 2327598, 2378754, 2454270, 2488122, 2493855, 2548665,
            2665845, 2685690, 2775213, 2863315, 2870910, 2992626, 3083570, 3155490, 3199014,
            3435978, 3491397, 3568131, 3611790, 3681405, 3732183, 3879330, 3964590, 4008641,
            4028535, 4146870, 4306365, 4417686, 4625355, 4733235, 4987710, 5097330, 5153967,
            5331690, 5550426, 5726630, 5818995, 5946885, 6220305, 6626529, 6982794, 7136262,
            7362810, 7464366, 7481565, 7997535, 8017282, 8057070, 8325639, 8589945, 8612730,
            9250710, 9466470, 10307934, 10474191, 11044215, 11196549, 11637990, 11893770, 12025923,
            12440610, 13253058, 13876065, 14963130, 15461901, 15995070, 16651278, 17179890,
            17456985, 17840655, 18660915, 20043205, 20948382, 22088430, 22393098, 24051846,
            24976917, 25769835, 27752130, 30923802, 33132645, 34913970, 35681310, 36077769,
            37321830, 40086410, 41628195, 46385703, 49953834, 51539670, 52370955, 55982745,
            60129615, 66265290, 72155538, 77309505, 83256390, 92771406, 104741910, 108233307,
            111965490, 120259230, 124884585, 154619010, 180388845, 216466614, 231928515, 249769170,
            324699921, 360777690, 463857030, 541166535, 649399842, 1082333070, 1623499605,
            3246999210,
        ];
        assert_eq!(d, expected);
    }
}
